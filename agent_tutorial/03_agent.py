"""
Agent - ì„¸ ë²ˆì§¸ ë‹¨ê³„
====================

ì´ íŒŒì¼ì—ì„œëŠ” Agentê°€ ë¬´ì—‡ì¸ì§€, Tool Callingê³¼ ì–´ë–»ê²Œ ë‹¤ë¥¸ì§€ ë°°ì›Œë´…ë‹ˆë‹¤.

Agentë€?
--------
AgentëŠ” ë³µì¡í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì—¬ëŸ¬ Toolì„ ì—°ì†ì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” 
ë” ë˜‘ë˜‘í•œ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

Tool Calling vs Agent:
- Tool Calling: LLMì´ í•œ ë²ˆì— Toolì„ í˜¸ì¶œí•˜ê³  ë
- Agent: ë¬¸ì œë¥¼ ë‹¨ê³„ë³„ë¡œ ë‚˜ëˆ„ì–´ ì—¬ëŸ¬ Toolì„ ìˆœì°¨ì ìœ¼ë¡œ ì‚¬ìš©

Agentì˜ íŠ¹ì§•:
1. ğŸ§  ìƒê°í•˜ê¸° (Reasoning): ë¬¸ì œë¥¼ ë¶„ì„í•˜ê³  ê³„íš ìˆ˜ë¦½
2. ğŸ”§ í–‰ë™í•˜ê¸° (Action): ì ì ˆí•œ Tool ì„ íƒí•˜ê³  ì‹¤í–‰
3. ğŸ‘€ ê´€ì°°í•˜ê¸° (Observation): Tool ê²°ê³¼ í™•ì¸
4. ğŸ”„ ë°˜ë³µí•˜ê¸°: ëª©í‘œ ë‹¬ì„±ê¹Œì§€ 2-3 ê³¼ì • ë°˜ë³µ
"""

# í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ import
from langchain.tools import tool
from langchain_openai import ChatOpenAI
from langchain.agents import create_tool_calling_agent, AgentExecutor
from langchain_core.prompts import ChatPromptTemplate
from typing import Annotated
import random

# í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
from dotenv import load_dotenv
load_dotenv()

# ============================================================================
# 1ë‹¨ê³„: Agentìš© Tool ì¤€ë¹„í•˜ê¸°
# ============================================================================

@tool
def search_product(query: Annotated[str, "ê²€ìƒ‰í•  ìƒí’ˆëª…"]) -> list:
    """ì˜¨ë¼ì¸ ì‡¼í•‘ëª°ì—ì„œ ìƒí’ˆì„ ê²€ìƒ‰í•©ë‹ˆë‹¤."""
    
    # ê°€ì§œ ìƒí’ˆ ë°ì´í„°ë² ì´ìŠ¤
    products = [
        {"ì´ë¦„": "ë¬´ì„  ì´ì–´í°", "ê°€ê²©": 89000, "í‰ì ": 4.5, "ì¬ê³ ": 15},
        {"ì´ë¦„": "ë¸”ë£¨íˆ¬ìŠ¤ ì´ì–´í°", "ê°€ê²©": 65000, "í‰ì ": 4.2, "ì¬ê³ ": 8},
        {"ì´ë¦„": "ë…¸ì´ì¦ˆìº”ìŠ¬ë§ í—¤ë“œí°", "ê°€ê²©": 159000, "í‰ì ": 4.8, "ì¬ê³ ": 3},
        {"ì´ë¦„": "ê²Œì´ë° í—¤ë“œì…‹", "ê°€ê²©": 95000, "í‰ì ": 4.3, "ì¬ê³ ": 12},
        {"ì´ë¦„": "ìŠ¤ë§ˆíŠ¸í°", "ê°€ê²©": 899000, "í‰ì ": 4.6, "ì¬ê³ ": 5},
        {"ì´ë¦„": "íƒœë¸”ë¦¿", "ê°€ê²©": 549000, "í‰ì ": 4.4, "ì¬ê³ ": 7},
        {"ì´ë¦„": "ë…¸íŠ¸ë¶", "ê°€ê²©": 1299000, "í‰ì ": 4.7, "ì¬ê³ ": 2},
    ]
    
    # ê²€ìƒ‰ì–´ì™€ ê´€ë ¨ëœ ìƒí’ˆ ì°¾ê¸°
    results = []
    for product in products:
        if query.lower() in product["ì´ë¦„"].lower():
            results.append(product)
    
    print(f"'{query}' ê²€ìƒ‰ ê²°ê³¼: {len(results)}ê°œ ìƒí’ˆ ë°œê²¬")
    return results

@tool
def check_inventory(product_name: Annotated[str, "ìƒí’ˆëª…"]) -> dict:
    """íŠ¹ì • ìƒí’ˆì˜ ì¬ê³ ë¥¼ í™•ì¸í•©ë‹ˆë‹¤."""
    
    # ê°€ì§œ ì¬ê³  ì •ë³´
    inventory = {
        "ë¬´ì„  ì´ì–´í°": {"ì¬ê³ ": 15, "ì…ê³ ì˜ˆì •": "2024-01-15"},
        "ë¸”ë£¨íˆ¬ìŠ¤ ì´ì–´í°": {"ì¬ê³ ": 8, "ì…ê³ ì˜ˆì •": "2024-01-10"},
        "ë…¸ì´ì¦ˆìº”ìŠ¬ë§ í—¤ë“œí°": {"ì¬ê³ ": 3, "ì…ê³ ì˜ˆì •": "2024-01-20"},
        "ê²Œì´ë° í—¤ë“œì…‹": {"ì¬ê³ ": 12, "ì…ê³ ì˜ˆì •": "2024-01-12"},
        "ìŠ¤ë§ˆíŠ¸í°": {"ì¬ê³ ": 5, "ì…ê³ ì˜ˆì •": "2024-01-18"},
    }
    
    result = inventory.get(product_name, {"ì¬ê³ ": 0, "ì…ê³ ì˜ˆì •": "ë¯¸ì •"})
    print(f"'{product_name}' ì¬ê³  í™•ì¸: {result}")
    return result

@tool
def calculate_shipping_cost(product_price: Annotated[float, "ìƒí’ˆ ê°€ê²©"], quantity: Annotated[int, "ìˆ˜ëŸ‰"]) -> dict:
    """ë°°ì†¡ë¹„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤."""
    
    total_price = product_price * quantity
    
    if total_price >= 50000:
        shipping_cost = 0
        shipping_type = "ë¬´ë£Œë°°ì†¡"
    else:
        shipping_cost = 3000
        shipping_type = "ì¼ë°˜ë°°ì†¡"
    
    result = {
        "ìƒí’ˆê¸ˆì•¡": total_price,
        "ë°°ì†¡ë¹„": shipping_cost,
        "ì´ê¸ˆì•¡": total_price + shipping_cost,
        "ë°°ì†¡íƒ€ì…": shipping_type
    }
    
    print(f"ë°°ì†¡ë¹„ ê³„ì‚° ê²°ê³¼: {result}")
    return result

@tool
def add_to_cart(product_name: Annotated[str, "ìƒí’ˆëª…"], quantity: Annotated[int, "ìˆ˜ëŸ‰"]) -> str:
    """ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€í•©ë‹ˆë‹¤."""
    
    cart_id = random.randint(10000, 99999)
    message = f"'{product_name}' {quantity}ê°œê°€ ì¥ë°”êµ¬ë‹ˆ(ID: {cart_id})ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."
    print(message)
    return message

# ============================================================================
# 2ë‹¨ê³„: Agent ìƒì„±í•˜ê¸°
# ============================================================================

def create_shopping_agent():
    """ì‡¼í•‘ ë„ìš°ë¯¸ Agentë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    
    # LLM ì„¤ì •
    llm = ChatOpenAI(
        model="gpt-4o-mini",
        temperature=0,
    )
    
    # Tool ëª©ë¡
    tools = [search_product, check_inventory, calculate_shipping_cost, add_to_cart]
    
    # Agentê°€ ì‚¬ìš©í•  í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
    prompt = ChatPromptTemplate.from_messages([
        ("system", """
ë‹¹ì‹ ì€ ì¹œì ˆí•œ ì˜¨ë¼ì¸ ì‡¼í•‘ ë„ìš°ë¯¸ Agentì…ë‹ˆë‹¤.
ê³ ê°ì˜ ì‡¼í•‘ì„ ë„ì™€ì£¼ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.

ë‹¤ìŒ ë„êµ¬ë“¤ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
- search_product: ìƒí’ˆ ê²€ìƒ‰
- check_inventory: ì¬ê³  í™•ì¸  
- calculate_shipping_cost: ë°°ì†¡ë¹„ ê³„ì‚°
- add_to_cart: ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€

ê³ ê°ì˜ ìš”ì²­ì„ ë‹¨ê³„ë³„ë¡œ ì²˜ë¦¬í•´ì£¼ì„¸ìš”:
1. ë¨¼ì € ìƒí’ˆì„ ê²€ìƒ‰í•©ë‹ˆë‹¤
2. ì¬ê³ ë¥¼ í™•ì¸í•©ë‹ˆë‹¤
3. í•„ìš”í•˜ë©´ ë°°ì†¡ë¹„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤
4. ê³ ê°ì´ ì›í•˜ë©´ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€í•©ë‹ˆë‹¤

í•­ìƒ ì¹œì ˆí•˜ê³  ë„ì›€ì´ ë˜ëŠ” ë‹µë³€ì„ í•´ì£¼ì„¸ìš”.
        """),
        ("human", "{input}"),
        ("placeholder", "{agent_scratchpad}")
    ])
    
    # Agent ìƒì„±
    agent = create_tool_calling_agent(llm, tools, prompt)
    
    # AgentExecutor ìƒì„± (Agentë¥¼ ì‹¤í–‰í•˜ëŠ” ì—”ì§„)
    agent_executor = AgentExecutor(
        agent=agent,
        tools=tools,
        verbose=True,  # Agentì˜ ì‚¬ê³  ê³¼ì •ì„ ë³´ì—¬ì¤Œ
        max_iterations=10,  # ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜
        handle_parsing_errors=True,  # ì˜¤ë¥˜ ì²˜ë¦¬
    )
    
    return agent_executor

# ============================================================================
# 3ë‹¨ê³„: Agent ì‚¬ìš©í•´ë³´ê¸°
# ============================================================================

def demo_agent():
    """Agent ë°ëª¨ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤."""
    
    print("ğŸ›’ ì‡¼í•‘ ë„ìš°ë¯¸ Agent ë°ëª¨")
    print("="*50)
    
    # Agent ìƒì„±
    shopping_agent = create_shopping_agent()
    
    # í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ë“¤
    scenarios = [
        {
            "ì œëª©": "ì‹œë‚˜ë¦¬ì˜¤ 1: ê°„ë‹¨í•œ ìƒí’ˆ ê²€ìƒ‰",
            "ì§ˆë¬¸": "ì´ì–´í°ì„ ì°¾ê³  ìˆì–´ìš”. ì–´ë–¤ ì œí’ˆë“¤ì´ ìˆë‚˜ìš”?"
        },
        {
            "ì œëª©": "ì‹œë‚˜ë¦¬ì˜¤ 2: êµ¬ì²´ì ì¸ êµ¬ë§¤ ìƒë‹´",
            "ì§ˆë¬¸": "ë¬´ì„  ì´ì–´í° 2ê°œë¥¼ ì‚¬ê³  ì‹¶ì€ë°, ì¬ê³ ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì´ ê¸ˆì•¡ì´ ì–¼ë§ˆì¸ì§€ ì•Œë ¤ì£¼ì„¸ìš”."
        },
        {
            "ì œëª©": "ì‹œë‚˜ë¦¬ì˜¤ 3: ë³µí•©ì ì¸ ì‡¼í•‘ ìš”ì²­",
            "ì§ˆë¬¸": "ê²Œì´ë° í—¤ë“œì…‹ì„ 3ê°œ ì£¼ë¬¸í•˜ë ¤ê³  í•©ë‹ˆë‹¤. ì¬ê³  í™•ì¸í•˜ê³ , ë°°ì†¡ë¹„ í¬í•¨ ì´ì•¡ ê³„ì‚°í•´ì„œ ì¥ë°”êµ¬ë‹ˆì— ë„£ì–´ì£¼ì„¸ìš”."
        }
    ]
    
    for i, scenario in enumerate(scenarios, 1):
        print(f"\n{'='*60}")
        print(f"ğŸ“‹ {scenario['ì œëª©']}")
        print(f"â“ ê³ ê° ì§ˆë¬¸: {scenario['ì§ˆë¬¸']}")
        print("-" * 60)
        
        try:
            # Agent ì‹¤í–‰
            result = shopping_agent.invoke({"input": scenario["ì§ˆë¬¸"]})
            
            print(f"\nğŸ¤– Agent ìµœì¢… ë‹µë³€:")
            print(f"{result['output']}")
            
        except Exception as e:
            print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
        
        if i < len(scenarios):
            print(f"\në‹¤ìŒ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë³´ë ¤ë©´ Enterë¥¼ ëˆ„ë¥´ì„¸ìš”...")
            input()

# ============================================================================
# 4ë‹¨ê³„: Agent vs Tool Calling ë¹„êµ
# ============================================================================

def explain_agent_vs_tool_calling():
    """Agentì™€ Tool Callingì˜ ì°¨ì´ì ì„ ì„¤ëª…í•©ë‹ˆë‹¤."""
    
    print("\nğŸ¯ Agent vs Tool Calling ë¹„êµ")
    print("="*50)
    
    print("""
ğŸ“ Tool Calling:
- LLMì´ í•œ ë²ˆì— í•„ìš”í•œ Toolì„ í˜¸ì¶œ
- ë‹¨ìˆœí•œ ì‘ì—…ì— ì í•©
- ì˜ˆ: "2 + 3ì„ ê³„ì‚°í•´ì¤˜" â†’ calculator í˜¸ì¶œ

ğŸ¤– Agent:
- ë³µì¡í•œ ë¬¸ì œë¥¼ ë‹¨ê³„ë³„ë¡œ í•´ê²°
- ì—¬ëŸ¬ Toolì„ ìˆœì°¨ì ìœ¼ë¡œ ì‚¬ìš©
- ì¤‘ê°„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ í–‰ë™ ê²°ì •
- ì˜ˆ: "ì´ì–´í° êµ¬ë§¤" â†’ ê²€ìƒ‰ â†’ ì¬ê³ í™•ì¸ â†’ ê°€ê²©ê³„ì‚° â†’ ì¥ë°”êµ¬ë‹ˆì¶”ê°€

ğŸ”„ Agentì˜ ì‚¬ê³  ê³¼ì • (ReAct íŒ¨í„´):
1. Reasoning (ì¶”ë¡ ): "ê³ ê°ì´ ì´ì–´í°ì„ ì›í•˜ë‹ˆê¹Œ ë¨¼ì € ê²€ìƒ‰í•´ì•¼ê² ë‹¤"
2. Action (í–‰ë™): search_product("ì´ì–´í°") ì‹¤í–‰
3. Observation (ê´€ì°°): ê²€ìƒ‰ ê²°ê³¼ í™•ì¸
4. Reasoning (ì¶”ë¡ ): "ì¬ê³ ë„ í™•ì¸í•´ì•¼ê² ë‹¤"
5. Action (í–‰ë™): check_inventory("ë¬´ì„  ì´ì–´í°") ì‹¤í–‰
... ë°˜ë³µ ...

ì´ëŸ° ì‹ìœ¼ë¡œ AgentëŠ” ìŠ¤ìŠ¤ë¡œ ìƒê°í•˜ê³  ê³„íší•˜ë©° ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤!
    """)

# ============================================================================
# ì‹¤í–‰ ë¶€ë¶„
# ============================================================================

if __name__ == "__main__":
    try:
        demo_agent()
        explain_agent_vs_tool_calling()
        
        print("\n" + "="*50)
        print("ğŸ“ í•™ìŠµ ì™„ë£Œ!")
        print("Tool â†’ Tool Calling â†’ Agent ìˆœì„œë¡œ ë°°ì› ìŠµë‹ˆë‹¤.")
        print("ë‹¤ìŒ íŒŒì¼ì—ì„œëŠ” ì‹¤ì œ ë°ì´í„° ë¶„ì„ Agentë¥¼ ë§Œë“¤ì–´ë´…ì‹œë‹¤!")
        
    except Exception as e:
        print(f"âš ï¸  ì˜¤ë¥˜ ë°œìƒ: {e}")
        print("OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”!")
